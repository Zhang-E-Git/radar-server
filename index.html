<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>逻辑和页面布局 - 编辑页</title>
<style>
body { font-family: Arial, sans-serif; background:#f5f5f5; padding:20px; }
.container { max-width:1000px; margin:0 auto; }
.rows-container { display:flex; flex-direction:column; gap:15px; margin-bottom:20px; }
.row-item { display:flex; align-items:center; gap:15px; padding:15px; background:white; border-radius:6px; }
.title-display, .url-display { flex:1; padding:10px; border-radius:6px; border:1px solid #ccc; }
.action-btn { padding:8px 15px; border:none; border-radius:6px; cursor:pointer; color:white; }
.jump-btn { background:#3498db; }
.edit-btn { background:#9b59b6; }
.add-btn { background:#2ecc71; }
.save-btn { background:#f39c12; }
.delete-btn { background:#e74c3c; }
</style>
</head>
<body>
<div class="container">
    <h1>逻辑和页面布局 - 编辑页</h1>
    <div class="rows-container" id="rowsContainer"></div>
    <div style="display:flex; gap:15px; margin-top:10px;">
        <button class="action-btn add-btn" id="addNewRowBtn">+ 增加新行</button>
        <button class="action-btn save-btn" id="saveAllDataBtn">💾 保存</button>
        <a class="action-btn jump-btn" href="display.html" target="_blank">🔗 查看展示页</a>
    </div>
    <div id="saveStatus" style="margin-top:10px;color:#27ae60"></div>
</div>

<!-- Supabase JS SDK -->
<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

// 初始化 Supabase
const supabaseUrl = 'https://edvljqszrcdamkyhwkwo.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVkdmxqcXN6cmNkYW1reWh3a3dvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0Nzk3ODEsImV4cCI6MjA3MzA1NTc4MX0.GCg-_jHoWMLWPwAlLQiOynEDL2XW7DTU9CsMUPzpPB4';
const supabase = createClient(supabaseUrl, supabaseKey);

let rowIdCounter = 1;

const rowsContainer = document.getElementById('rowsContainer');
const addNewRowBtn = document.getElementById('addNewRowBtn');
const saveAllDataBtn = document.getElementById('saveAllDataBtn');
const saveStatus = document.getElementById('saveStatus');

function createRowElement(rowData) {
    const newRow = document.createElement('div');
    newRow.className = 'row-item';
    newRow.setAttribute('data-id', rowData.id);
    newRow.innerHTML = `
        <div class="title-display">${rowData.title}</div>
        <div class="url-display">${rowData.url}</div>
        <button class="action-btn jump-btn">↗ 跳转</button>
        <button class="action-btn edit-btn">✎ 编辑</button>
        <button class="action-btn delete-btn">✕ 删除</button>
    `;

    // 跳转按钮
    const jumpBtn = newRow.querySelector('.jump-btn');
    jumpBtn.addEventListener('click', () => {
        const url = newRow.querySelector('.url-display').textContent.trim();
        if(!url) { alert('链接为空'); return; }
        window.open(url, '_blank');
    });

    // 编辑按钮
    const editBtn = newRow.querySelector('.edit-btn');
    editBtn.addEventListener('click', () => {
        if(editBtn.textContent === '✎ 编辑') {
            enterEditMode(newRow, editBtn);
        } else if(editBtn.textContent === '✓ 完成') {
            finishEditMode(newRow, editBtn);
        }
    });

    // 删除按钮
    const deleteBtn = newRow.querySelector('.delete-btn');
    deleteBtn.addEventListener('click', async () => {
        const id = newRow.getAttribute('data-id');
        if(id.toString().startsWith('temp-')) {
            // 只是前端临时行，直接移除
            newRow.remove();
            return;
        }
        if(!confirm('确认删除该行吗？')) return;
        try {
            const { error } = await supabase.from('rows').delete().eq('id', id);
            if(error) throw error;
            newRow.remove();
            saveStatus.textContent = '删除成功！';
        } catch(e) {
            alert('删除失败: ' + e.message);
        }
    });

    return newRow;
}

function renderRow(rowData) {
    const existingRow = rowsContainer.querySelector(`[data-id="${rowData.id}"]`);
    if(existingRow) {
        rowsContainer.replaceChild(createRowElement(rowData), existingRow);
    } else {
        rowsContainer.appendChild(createRowElement(rowData));
    }
}

// 新增行函数，直接插入数据库
async function addNewRow(title = '', url = '') {
    try {
        // 不传 id，让数据库自增生成
        const { data, error } = await supabase
            .from('rows')
            .insert({ title, url })
            .select();
        if (error) throw error;
        if (data && data.length > 0) {
            renderRow(data[0]);
            saveStatus.textContent = '新增成功！';
        }
    } catch (e) {
        alert('新增失败: ' + e.message);
    }
}

function enterEditMode(row, editBtn) {
    const titleElem = row.querySelector('.title-display');
    const urlElem = row.querySelector('.url-display');

    const titleEdit = document.createElement('div');
    titleEdit.className = 'title-display';
    titleEdit.contentEditable = true;
    titleEdit.textContent = titleElem.textContent;

    const urlEdit = document.createElement('div');
    urlEdit.className = 'url-display';
    urlEdit.contentEditable = true;
    urlEdit.textContent = urlElem.textContent;

    row.replaceChild(titleEdit, titleElem);
    row.replaceChild(urlEdit, urlElem);

    editBtn.textContent = '✓ 完成';

    // 防止多次绑定
    titleEdit.removeEventListener('keydown', titleEdit._enterHandler);
    urlEdit.removeEventListener('keydown', urlEdit._enterHandler);

    titleEdit._enterHandler = (e) => { if(e.key === 'Enter') { e.preventDefault(); titleEdit.blur(); } };
    urlEdit._enterHandler = (e) => { if(e.key === 'Enter') { e.preventDefault(); urlEdit.blur(); } };

    titleEdit.addEventListener('keydown', titleEdit._enterHandler);
    urlEdit.addEventListener('keydown', urlEdit._enterHandler);
}

async function finishEditMode(row, editBtn) {
    const titleEdit = row.querySelector('.title-display');
    const urlEdit = row.querySelector('.url-display');

    const newTitle = titleEdit.textContent.trim();
    const newUrl = urlEdit.textContent.trim();
    const id = row.getAttribute('data-id');

    try {
        if(id.toString().startsWith('temp-')) {
            // 临时行不应存在，理论上不会到这里
            alert('临时行无法编辑保存，请刷新页面。');
            return;
        }
        const { error } = await supabase.from('rows').update({title: newTitle, url: newUrl}).eq('id', id);
        if(error) throw error;

        // 替换为不可编辑元素
        const titleDisplay = document.createElement('div');
        titleDisplay.className = 'title-display';
        titleDisplay.textContent = newTitle;

        const urlDisplay = document.createElement('div');
        urlDisplay.className = 'url-display';
        urlDisplay.textContent = newUrl;

        row.replaceChild(titleDisplay, titleEdit);
        row.replaceChild(urlDisplay, urlEdit);

        editBtn.textContent = '✎ 编辑';
        saveStatus.textContent = '更新成功！';
    } catch(e) {
        alert('更新失败: ' + e.message);
    }
}

// 保存所有行，针对新增的临时行（理论上不会有临时行，因为新增即插入）
async function saveAllData() {
    // 这里不再有临时行，因为新增行直接插入数据库了
    saveStatus.textContent = '所有数据已实时保存，无需手动保存。';
}

// 从 Supabase 加载数据
async function loadRowsFromSupabase() {
    rowsContainer.innerHTML = '';
    try {
        const { data, error } = await supabase.from('rows').select('*').order('id', {ascending:true});
        if(error) throw error;
        data.forEach(row => renderRow(row));
    } catch(e) {
        alert('加载数据失败: ' + e.message);
    }
}

// 初始化绑定事件
function init() {
    addNewRowBtn.addEventListener('click', () => {
        addNewRow('新标题', 'https://');
    });
    saveAllDataBtn.addEventListener('click', () => {
        saveAllData();
    });
    loadRowsFromSupabase();
}

window.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>