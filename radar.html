<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>寻宝雷达 · 圆形信息显示</title>
  <style>
    :root {
      --bg: #000;
      --btn-bg: #151515;
      --btn-border: #2a2a2a;
      --btn-text: #eaeaea;
      --accent: #1ea36a;
      --radar-bg-inner: #0e5b40;
      --radar-bg-middle: #0c4c37;
      --radar-bg-outer: #093c2c;
    }

    html, body { margin: 0; height: 100%; background: var(--bg); color: #fff; font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Helvetica Neue",Arial,"Noto Sans","PingFang SC","Hiragino Sans GB","Microsoft YaHei",sans-serif; }

    .app { min-height: 100%; display: flex; flex-direction: column; align-items: center; gap: 12px; padding: 16px 14px 24px; }

    /* 顶部按钮 */
    .controls { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; width: 100%; max-width: 560px; position: sticky; top: 0; z-index: 5; background: linear-gradient(180deg, rgba(0,0,0,.9), rgba(0,0,0,0)); padding-top: 4px; }
    .btn { -webkit-tap-highlight-color: transparent; user-select: none; border: 1px solid var(--btn-border); background: var(--btn-bg); color: var(--btn-text); border-radius: 12px; padding: 12px 10px; font-size: 16px; font-weight: 600; text-align: center; }
    .btn:active { transform: translateY(1px) scale(0.995); background: #0e0e0e; border-color: #333; }

    /* 页面容器 */
    .page { width: 100%; max-width: 560px; }
    .hidden { display: none !important; }

    /* 雷达/信息画布区域 */
    .square-wrap { width: 100%; aspect-ratio: 1/1; position: relative; display: grid; place-items: center; margin-top: 6px; border-radius: 16px; overflow: hidden; }

    /* 圆形显示区域（雷达和信息共享） */
    .circle-display {
      display: block;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background: radial-gradient(circle at 50% 50%, var(--radar-bg-inner) 0%, var(--radar-bg-middle) 55%, var(--radar-bg-outer) 100%);
      box-shadow: 0 0 40px rgba(30,163,106,.25) inset, 0 0 120px rgba(30,163,106,.15) inset;
      position: relative;
      overflow: hidden;
    }

    #radar {
      width: 100%;
      height: 100%;
      display: block;
    }

    .legend { opacity: .75; font-size: 12px; margin-top: 6px; }

    /* 信息部分样式 - 适应圆形区域 */
    .info-content { 
      width: 100%; 
      height: 100%;
      position: absolute;
      top: 0;
      left: 0;
      display: flex; 
      flex-direction: column; 
      justify-content: center; 
      align-items: center; 
      padding: 20% 10%;
      box-sizing: border-box;
      overflow: hidden;
    }
    
    .info-item {
      width: 100%;
      display: flex;
      justify-content: space-between;
      padding: 8px 10px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      font-size: 14px;
      z-index: 1;
    }
    
    .info-item:last-child {
      border-bottom: none;
    }
    
    .info-label {
      color: #aaa;
    }
    
    .info-value {
      color: #fff;
      font-weight: 600;
    }
    
    .signal-strong {
      color: var(--accent);
    }
    
    .progress-container {
      width: 100%;
      height: 6px;
      background-color: rgba(255,255,255,0.1);
      border-radius: 3px;
      overflow: hidden;
      margin-top: 3px;
    }
    
    .progress-bar {
      height: 100%;
      background-color: var(--accent);
    }
    
    .top-chip { 
      position: absolute; 
      top: 10%; 
      left: 50%; 
      transform: translateX(-50%); 
      font-size: 12px; 
      opacity: .9; 
      background: rgba(0,0,0,0.3); 
      padding: 3px 8px; 
      border-radius: 6px; 
      border: 1px solid rgba(255,255,255,0.1);
      z-index: 1;
    }

    /* 雷达页的授权按钮 */
    .perm-btn { margin-top: 8px; padding: 10px 12px; font-size: 13px; border-radius: 10px; border: 1px solid #2a2a2a; background: #111; color: #eee; width: 100%; max-width: 560px; }
  </style>
</head>
<body>
  <div class="app">
    <div class="controls" role="group" aria-label="雷达控制">
      <button id="btn-left" class="btn" aria-label="缩小网格比例尺">左</button>
      <button id="btn-confirm" class="btn" aria-label="按住显示信息">确认</button>
      <button id="btn-right" class="btn" aria-label="放大网格比例尺">右</button>
    </div>

    <!-- 雷达页面 -->
    <section id="radarPage" class="page">
      <div class="square-wrap">
        <div class="circle-display">
          <canvas id="radar" aria-label="雷达"></canvas>
        </div>
      </div>
      <div class="legend">左=缩小比例尺，右=放大比例尺；支持<strong>鼠标滚轮平滑缩放</strong>；按住“确认”显示信息；授权地磁传感器后，转动方向，标记点相对位置会实时变化。</div>
      <button id="requestPerm" class="perm-btn">授权方向/地磁传感器（iOS 需授权）</button>
    </section>

    <!-- 信息页面 - 现在在圆形区域内显示 -->
    <section id="infoPage" class="page hidden">
      <div class="square-wrap">
        <div class="circle-display">
          <div class="info-content">
            <div class="top-chip">探索信息</div>
            
            <div class="info-item">
              <span class="info-label">设备电量</span>
              <span class="info-value">100%</span>
            </div>
            <div class="info-item">
              <span class="info-label">GPS信号</span>
              <span class="info-value signal-strong">强</span>
            </div>
            <div class="info-item">
              <span class="info-label">路线名称</span>
              <span class="info-value">湿地探索路线A</span>
            </div>
            <div class="info-item">
              <span class="info-label">探索时长</span>
              <span class="info-value">1h15m</span>
            </div>
            <div class="info-item">
              <span class="info-label">已探索点位</span>
              <span class="info-value">3/10</span>
            </div>
            <div class="info-item">
              <span class="info-label">完成进度</span>
              <div class="progress-container">
                <div class="progress-bar" style="width: 30%;"></div>
              </div>
            </div>
            <div class="info-item">
              <span class="info-label">分数</span>
              <span class="info-value">8/20</span>
            </div>
          </div>
        </div>
      </div>
      <div class="legend">松开“确认”返回雷达。</div>
    </section>
  </div>

  <script>
    // =============== 雷达状态与工具 ===============
    const canvas = document.getElementById('radar');
    const ctx = canvas.getContext('2d');
    const state = { angle:-Math.PI/2, sweep:Math.PI/7, blips:[], r:0, center:{x:0,y:0}, gridStep:40, animId:null, t:0, headingRad:0 };

    function fitCanvas(){
      const dpr = Math.max(1, window.devicePixelRatio||1);
      const rect = canvas.getBoundingClientRect();
      canvas.width=Math.floor(rect.width*dpr);
      canvas.height=Math.floor(rect.height*dpr);
      ctx.setTransform(dpr,0,0,dpr,0,0);
      state.center.x=rect.width/2; state.center.y=rect.height/2; state.r=Math.min(rect.width,rect.height)/2*0.92;
    }

    // 世界→设备坐标：先按朝向旋转，再投影
    function worldToScreen(wx,wy){
      const h = state.headingRad; // 设备面向：0 朝北（屏幕上方），顺时针为正
      const cosh = Math.cos(h), sinh = Math.sin(h);
      const dx =  wx *  cosh + wy *  sinh;
      const dy = -wx *  sinh + wy *  cosh;
      return { x: state.center.x + dx * state.gridStep, y: state.center.y + dy * state.gridStep };
    }

    function insideCircle(x,y){const dx=x-state.center.x,dy=y-state.center.y;return dx*dx+dy*dy<=state.r*state.r;}

    function randomBlips(){
      const pts=[]; const radius=(state.r/state.gridStep)*0.98;
      
      // 添加指定数量的标记点
      // 2个绿色标记点
      pts.push({ wx: 1.2, wy: 0.8, color: "green" });
      pts.push({ wx: -1.5, wy: -1.2, color: "green" });
      
      // 1个蓝色标记点
      pts.push({ wx: 2.0, wy: -1.0, color: "blue" });
      
      // 1个灰色标记点
      pts.push({ wx: -0.8, wy: 1.5, color: "gray" });
      
      // 1个红色标记点（作为额外点）
      pts.push({ wx: 1.0, wy: 1.8, color: "red" });
      
      // 1个三角旗标记
      pts.push({ wx: -1.8, wy: 0.5, color: "flag" });
      
      state.blips=pts;
    }

    // =============== 绘制：网格、扇形、标记点 ===============
    function drawGrid(){
      const {x:cx,y:cy}=state.center,R=state.r;
      // 背景微光
      const glow = ctx.createRadialGradient(cx, cy, 0, cx, cy, R);
      glow.addColorStop(0, 'rgba(30,163,106,0.08)'); glow.addColorStop(1, 'rgba(30,163,106,0.0)');
      ctx.fillStyle = glow; ctx.beginPath(); ctx.arc(cx,cy,R,0,Math.PI*2); ctx.fill();

      // 裁剪圆
      ctx.save(); ctx.beginPath(); ctx.arc(cx,cy,R,0,Math.PI*2); ctx.clip();
      // 经纬网格（半透明实线）
      ctx.strokeStyle='rgba(255,255,255,0.35)';
      ctx.lineWidth=1; // 实线
      ctx.setLineDash([]);
      const left=cx-R,right=cx+R,top=cy-R,bottom=cy+R,step=Math.max(8,Math.min(160,state.gridStep));
      for(let x=Math.floor(left/step)*step; x<=right; x+=step){ ctx.beginPath(); ctx.moveTo(x,top); ctx.lineTo(x,bottom); ctx.stroke(); }
      for(let y=Math.floor(top/step)*step; y<=bottom; y+=step){ ctx.beginPath(); ctx.moveTo(left,y); ctx.lineTo(right,y); ctx.stroke(); }
      ctx.restore();
      // 外圈
      ctx.beginPath(); ctx.arc(cx,cy,R,0,Math.PI*2); ctx.setLineDash([]); ctx.lineWidth=1.5; ctx.strokeStyle='rgba(255,255,255,0.9)'; ctx.stroke();

      // NSEW 标识随设备朝向旋转
      ctx.save();
      ctx.translate(cx, cy);
      ctx.rotate(-state.headingRad); // 逆时针旋转，使得N指向现实北
      ctx.fillStyle = "white";
      ctx.font = `${Math.floor(R*0.1)}px sans-serif`;
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText("N", 0, -R+15);
      ctx.fillText("S", 0, R-15);
      ctx.fillText("E", R-15, 0);
      ctx.fillText("W", -R+15, 0);
      ctx.restore();
    }

    function drawSector(){
      const {x:cx,y:cy}=state.center,R=state.r; // 扇形固定向上
      const angle=-Math.PI/2, sweep=state.sweep;
      ctx.save(); ctx.translate(cx,cy); ctx.rotate(angle);
      ctx.beginPath(); ctx.moveTo(0, 0); ctx.arc(0,0,R,-sweep/2,sweep/2,false); ctx.closePath(); ctx.clip();
      const grad=ctx.createLinearGradient(0,-R,0,R); grad.addColorStop(0,'rgba(255,255,255,0)'); grad.addColorStop(0.55,'rgba(255,255,255,0.2)'); grad.addColorStop(1,'rgba(255,255,255,0.65)');
      ctx.fillStyle=grad; ctx.fillRect(-R,-R,R*2,R*2);
      ctx.strokeStyle='rgba(255,255,255,0.85)'; ctx.lineWidth=1.2; ctx.beginPath(); ctx.moveTo(0,0); ctx.arc(0,0,R,-sweep/2,sweep/2,false); ctx.closePath(); ctx.stroke();
      ctx.restore();
    }

    function drawBlips(){
      const pulse=(Math.sin(state.t)+1)/2;
      for(const b of state.blips){
        const {x,y}=worldToScreen(b.wx,b.wy);
        if(!insideCircle(x,y)) continue;
        const r=4+pulse*2;
        
        // 脉冲效果
        ctx.beginPath();
        ctx.fillStyle=`rgba(255,255,255,${0.12+0.18*pulse})`;
        ctx.arc(x,y,r*2.4,0,Math.PI*2);
        ctx.fill();

        // 根据颜色绘制点
        let c = "#ff3b30"; // 默认红
        if(b.color==="green") c="#1aff1a";
        if(b.color==="blue")  c="#3399ff";
        if(b.color==="gray")  c="#aaaaaa";

        // 绘制标记点
        if(b.color === "flag") {
          // 绘制三角旗
          ctx.save();
          ctx.translate(x, y);
          ctx.rotate(-state.headingRad); // 保持旗帜方向正确
          ctx.fillStyle = "#ffcc00";
          ctx.beginPath();
          ctx.moveTo(0, -r);
          ctx.lineTo(r*1.5, 0);
          ctx.lineTo(0, r);
          ctx.closePath();
          ctx.fill();
          ctx.restore();
        } else {
          // 绘制圆形标记
          ctx.beginPath();
          ctx.fillStyle = c;
          ctx.arc(x, y, r, 0, Math.PI*2);
          ctx.fill();
        }
      }
    }

    function render(){
      const rect=canvas.getBoundingClientRect(); ctx.clearRect(0,0,rect.width,rect.height);
      drawGrid(); drawSector(); drawBlips(); state.t+=0.06; state.animId=requestAnimationFrame(render);
    }

    // =============== 缩放交互（按钮 + 鼠标滚轮） ===============
    const BUTTON_STEP = 4; // 按钮更小步进，更平滑

    document.getElementById('btn-left').addEventListener('click',()=>{ state.gridStep=Math.min(160,state.gridStep+BUTTON_STEP); });
    document.getElementById('btn-right').addEventListener('click',()=>{ state.gridStep=Math.max(8,state.gridStep-BUTTON_STEP); });

    // 鼠标滚轮平滑缩放
    canvas.addEventListener('wheel', (e)=>{
      e.preventDefault();
      const sensitivity = 0.0015;
      const factor = Math.exp(-e.deltaY * sensitivity);
      state.gridStep = Math.max(8, Math.min(160, state.gridStep * factor));
    }, { passive: false });

    // =============== 页面切换（按住确认） ===============
    const radarPage=document.getElementById('radarPage');
    const infoPage=document.getElementById('infoPage');
    const btnConfirm=document.getElementById('btn-confirm');

    function showInfo(){ radarPage.classList.add('hidden'); infoPage.classList.remove('hidden'); }
    function showRadar(){ infoPage.classList.add('hidden'); radarPage.classList.remove('hidden'); }

    btnConfirm.addEventListener('pointerdown', (e)=>{ try{ btnConfirm.setPointerCapture(e.pointerId); }catch(_){} showInfo(); });
    btnConfirm.addEventListener('pointerup',   ()=>{ showRadar(); });
    btnConfirm.addEventListener('pointercancel', ()=>{ showRadar(); });
    btnConfirm.addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); });

    // =============== 方向/地磁传感器 ===============
    const requestPermBtn=document.getElementById('requestPerm');

    function updateHeading(deg){
      state.headingRad = deg * Math.PI / 180;
    }

    async function requestPermissionIfNeeded(){
      const DOE = window.DeviceOrientationEvent;
      if (DOE && typeof DOE.requestPermission === 'function') {
        try { const res = await DOE.requestPermission(); return res === 'granted'; } catch(_) { return false; }
      }
      return true;
    }

    function onDeviceOrientation(e){
      let heading;
      if (typeof e.webkitCompassHeading === 'number') heading = e.webkitCompassHeading;
      else if (typeof e.alpha === 'number') heading = 360 - e.alpha;
      if (typeof heading === 'number' && isFinite(heading)) { heading=(heading%360+360)%360; updateHeading(heading); }
    }

    requestPermBtn.addEventListener('click', async ()=>{
      const ok = await requestPermissionIfNeeded();
      if (ok) {
        if (window.DeviceOrientationEvent) {
          window.addEventListener('deviceorientation', onDeviceOrientation, { passive:true });
        }
        requestPermBtn.textContent = '已授权：转动设备查看变化';
      } else {
        requestPermBtn.textContent = '未授权/不支持：请在系统设置中开启';
      }
    });

    // =============== 初始化 ===============
    function init(){ fitCanvas(); randomBlips(); if(state.animId) cancelAnimationFrame(state.animId); render(); }
    window.addEventListener('resize', fitCanvas);
    window.addEventListener('orientationchange', ()=> setTimeout(fitCanvas, 200));
    document.addEventListener('contextmenu', e=> e.preventDefault());
    init();
  </script>
</body>
</html>
    