<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>寻宝雷达 · 平滑缩放&半透明经纬线</title>
  <style>
    :root {
      --bg: #000;
      --btn-bg: #151515;
      --btn-border: #2a2a2a;
      --btn-text: #eaeaea;
      --accent: #1ea36a;
    }

    html, body { margin: 0; height: 100%; background: var(--bg); color: #fff; font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Helvetica Neue",Arial,"Noto Sans","PingFang SC","Hiragino Sans GB","Microsoft YaHei",sans-serif; }

    .app { min-height: 100%; display: flex; flex-direction: column; align-items: center; gap: 12px; padding: 16px 14px 24px; }

    /* 顶部按钮 */
    .controls { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; width: 100%; max-width: 560px; position: sticky; top: 0; z-index: 5; background: linear-gradient(180deg, rgba(0,0,0,.9), rgba(0,0,0,0)); padding-top: 4px; }
    .btn { -webkit-tap-highlight-color: transparent; user-select: none; border: 1px solid var(--btn-border); background: var(--btn-bg); color: var(--btn-text); border-radius: 12px; padding: 12px 10px; font-size: 16px; font-weight: 600; text-align: center; }
    .btn:active { transform: translateY(1px) scale(0.995); background: #0e0e0e; border-color: #333; }

    /* 页面容器 */
    .page { width: 100%; max-width: 560px; }
    .hidden { display: none !important; }

    /* 雷达/指南针画布区域 */
    .square-wrap { width: 100%; aspect-ratio: 1/1; position: relative; display: grid; place-items: center; margin-top: 6px; border-radius: 16px; overflow: hidden; }

    /* 雷达画布背景（绿色圆） */
    #radar { display: block; width: 100%; height: 100%; border-radius: 50%; background: radial-gradient(circle at 50% 50%, #0e5b40 0%, #0c4c37 55%, #093c2c 100%); box-shadow: 0 0 40px rgba(30,163,106,.25) inset, 0 0 120px rgba(30,163,106,.15) inset; }

    .legend { opacity: .75; font-size: 12px; margin-top: 6px; }

    /* 指南针样式 */
    .compass-surface { aspect-ratio: 1/1; width: 100%; border-radius: 16px; background: radial-gradient(circle at 50% 50%, #0b0b0b 0%, #050505 100%); display: grid; place-items: center; position: relative; }
    .rose { position: absolute; inset: 10%; border-radius: 50%; border: 1px solid #2f2f2f; }
    .tick { position: absolute; left: 50%; top: 50%; width: 2px; height: 12%; transform-origin: bottom center; background: #3a3a3a; }
    .label { position: absolute; font-weight: 700; }
    .label.n { top: 6%; left: 50%; transform: translateX(-50%); color: #ff4d4f; }
    .label.s { bottom: 6%; left: 50%; transform: translateX(-50%); }
    .label.e { right: 6%; top: 50%; transform: translateY(-50%); }
    .label.w { left: 6%; top: 50%; transform: translateY(-50%); }
    .needle { position: absolute; width: 2px; height: 38%; background: linear-gradient(#ff4d4f, #991a1d); transform-origin: bottom center; bottom: 50%; left: 50%; transform: translateX(-50%) rotate(0deg); box-shadow: 0 0 10px rgba(255,77,79,.45); }
    .center-dot { position: absolute; width: 10px; height: 10px; background: #ddd; border-radius: 50%; left: 50%; top: 50%; transform: translate(-50%,-50%); box-shadow: 0 0 12px rgba(255,255,255,.25) inset; }

    .top-chip { position:absolute; top:8px; left:50%; transform:translateX(-50%); font-size:12px; opacity:.9; background:rgba(0,0,0,.35); padding:4px 8px; border-radius:8px; border:1px solid #2a2a2a; }

    /* 雷达页的授权按钮 */
    .perm-btn { margin-top: 8px; padding: 10px 12px; font-size: 13px; border-radius: 10px; border: 1px solid #2a2a2a; background: #111; color: #eee; width: 100%; max-width: 560px; }
  </style>
</head>
<body>
  <div class="app">
    <div class="controls" role="group" aria-label="雷达控制">
      <button id="btn-left" class="btn" aria-label="缩小网格比例尺">左</button>
      <button id="btn-confirm" class="btn" aria-label="按住显示指南针">确认</button>
      <button id="btn-right" class="btn" aria-label="放大网格比例尺">右</button>
    </div>

    <!-- 雷达页面 -->
    <section id="radarPage" class="page">
      <div class="square-wrap"><canvas id="radar" aria-label="雷达"></canvas></div>
      <div class="legend">左=缩小比例尺，右=放大比例尺；支持<strong>鼠标滚轮平滑缩放</strong>；按住“确认”显示指南针；授权地磁传感器后，转动方向，红点相对位置会实时变化，扇形始终指向前方。</div>
      <button id="requestPerm" class="perm-btn">授权方向/地磁传感器（iOS 需授权）</button>
    </section>

    <!-- 指南针页面 -->
    <section id="compassPage" class="page hidden">
      <div class="square-wrap">
        <div class="compass-surface">
          <div class="rose"></div>
          <div class="tick" style="transform: translate(-50%,-100%) rotate(0deg);"></div>
          <div class="tick" style="transform: translate(-50%,-100%) rotate(90deg);"></div>
          <div class="tick" style="transform: translate(-50%,-100%) rotate(180deg);"></div>
          <div class="tick" style="transform: translate(-50%,-100%) rotate(270deg);"></div>
          <div class="label n">N</div>
          <div class="label e">E</div>
          <div class="label s">S</div>
          <div class="label w">W</div>
          <div id="needle" class="needle"></div>
          <div class="center-dot"></div>
          <div id="headingTxt" class="top-chip">朝向：--°</div>
        </div>
      </div>
      <div class="legend">松开“确认”返回雷达。</div>
    </section>
  </div>

  <script>
    // =============== 雷达状态与工具 ===============
    const canvas = document.getElementById('radar');
    const ctx = canvas.getContext('2d');
    const state = { angle:-Math.PI/2, sweep:Math.PI/7, blips:[], r:0, center:{x:0,y:0}, gridStep:40, animId:null, t:0, headingRad:0 };

    function fitCanvas(){
      const dpr = Math.max(1, window.devicePixelRatio||1);
      const rect = canvas.getBoundingClientRect();
      canvas.width=Math.floor(rect.width*dpr);
      canvas.height=Math.floor(rect.height*dpr);
      ctx.setTransform(dpr,0,0,dpr,0,0);
      state.center.x=rect.width/2; state.center.y=rect.height/2; state.r=Math.min(rect.width,rect.height)/2*0.92;
    }

    // 世界→设备坐标：先按朝向旋转，再投影
    function worldToScreen(wx,wy){
      const h = state.headingRad; // 设备面向：0 朝北（屏幕上方），顺时针为正
      const cosh = Math.cos(h), sinh = Math.sin(h);
      const dx =  wx *  cosh + wy *  sinh;
      const dy = -wx *  sinh + wy *  cosh;
      return { x: state.center.x + dx * state.gridStep, y: state.center.y + dy * state.gridStep };
    }

    function insideCircle(x,y){const dx=x-state.center.x,dy=y-state.center.y;return dx*dx+dy*dy<=state.r*state.r;}

    function randomBlips(n=3){
      const pts=[]; const radius=(state.r/state.gridStep)*0.98;
      for(let i=0;i<n;i++){const rr=Math.sqrt(Math.random())*radius;const th=Math.random()*Math.PI*2;pts.push({wx:rr*Math.cos(th),wy:rr*Math.sin(th)});} state.blips=pts;
    }

    // =============== 绘制：网格、扇形、红点 ===============
    function drawGrid(){
      const {x:cx,y:cy}=state.center,R=state.r;
      // 背景微光
      const glow = ctx.createRadialGradient(cx, cy, 0, cx, cy, R);
      glow.addColorStop(0, 'rgba(30,163,106,0.08)'); glow.addColorStop(1, 'rgba(30,163,106,0.0)');
      ctx.fillStyle = glow; ctx.beginPath(); ctx.arc(cx,cy,R,0,Math.PI*2); ctx.fill();

      // 裁剪圆
      ctx.save(); ctx.beginPath(); ctx.arc(cx,cy,R,0,Math.PI*2); ctx.clip();
      // 经纬网格（半透明实线，无虚线）
      ctx.strokeStyle='rgba(255,255,255,0.35)';
      ctx.lineWidth=1; // 实线
      ctx.setLineDash([]);
      const left=cx-R,right=cx+R,top=cy-R,bottom=cy+R,step=Math.max(8,Math.min(160,state.gridStep));
      for(let x=Math.floor(left/step)*step; x<=right; x+=step){ ctx.beginPath(); ctx.moveTo(x,top); ctx.lineTo(x,bottom); ctx.stroke(); }
      for(let y=Math.floor(top/step)*step; y<=bottom; y+=step){ ctx.beginPath(); ctx.moveTo(left,y); ctx.lineTo(right,y); ctx.stroke(); }
      ctx.restore();
      // 外圈
      ctx.beginPath(); ctx.arc(cx,cy,R,0,Math.PI*2); ctx.setLineDash([]); ctx.lineWidth=1.5; ctx.strokeStyle='rgba(255,255,255,0.9)'; ctx.stroke();
    }

    function drawSector(){
      const {x:cx,y:cy}=state.center,R=state.r; // 扇形固定向上
      const angle=-Math.PI/2, sweep=state.sweep;
      ctx.save(); ctx.translate(cx,cy); ctx.rotate(angle);
      ctx.beginPath(); ctx.moveTo(0, 0); ctx.arc(0,0,R,-sweep/2,sweep/2,false); ctx.closePath(); ctx.clip();
      const grad=ctx.createLinearGradient(0,-R,0,R); grad.addColorStop(0,'rgba(255,255,255,0)'); grad.addColorStop(0.55,'rgba(255,255,255,0.2)'); grad.addColorStop(1,'rgba(255,255,255,0.65)');
      ctx.fillStyle=grad; ctx.fillRect(-R,-R,R*2,R*2);
      ctx.strokeStyle='rgba(255,255,255,0.85)'; ctx.lineWidth=1.2; ctx.beginPath(); ctx.moveTo(0,0); ctx.arc(0,0,R,-sweep/2,sweep/2,false); ctx.closePath(); ctx.stroke();
      ctx.restore();
    }

    function drawBlips(){
      const pulse=(Math.sin(state.t)+1)/2; // 0~1
      for(const b of state.blips){ const {x,y}=worldToScreen(b.wx,b.wy); if(!insideCircle(x,y)) continue; const r=4+pulse*2; ctx.beginPath(); ctx.fillStyle=`rgba(255,59,48,${0.12+0.18*pulse})`; ctx.arc(x,y,r*2.4,0,Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.fillStyle='#ff3b30'; ctx.arc(x,y,r,0,Math.PI*2); ctx.fill(); }
    }

    function render(){
      const rect=canvas.getBoundingClientRect(); ctx.clearRect(0,0,rect.width,rect.height);
      drawGrid(); drawSector(); drawBlips(); state.t+=0.06; state.animId=requestAnimationFrame(render);
    }

    // =============== 缩放交互（按钮 + 鼠标滚轮） ===============
    const BUTTON_STEP = 4; // 按钮更小步进，更平滑

    document.getElementById('btn-left').addEventListener('click',()=>{ state.gridStep=Math.min(160,state.gridStep+BUTTON_STEP); });
    document.getElementById('btn-right').addEventListener('click',()=>{ state.gridStep=Math.max(8,state.gridStep-BUTTON_STEP); });

    // 鼠标滚轮平滑缩放：使用乘法因子，随滚动速度线性映射到指数缩放
    canvas.addEventListener('wheel', (e)=>{
      e.preventDefault();
      const sensitivity = 0.0015; // 越大缩放越灵敏
      const factor = Math.exp(-e.deltaY * sensitivity);
      state.gridStep = Math.max(8, Math.min(160, state.gridStep * factor));
    }, { passive: false });

    // =============== 页面切换（按住确认） ===============
    const radarPage=document.getElementById('radarPage');
    const compassPage=document.getElementById('compassPage');
    const btnConfirm=document.getElementById('btn-confirm');

    function showCompass(){ radarPage.classList.add('hidden'); compassPage.classList.remove('hidden'); }
    function showRadar(){ compassPage.classList.add('hidden'); radarPage.classList.remove('hidden'); }

    btnConfirm.addEventListener('pointerdown', (e)=>{ try{ btnConfirm.setPointerCapture(e.pointerId); }catch(_){} showCompass(); });
    btnConfirm.addEventListener('pointerup',   ()=>{ showRadar(); });
    btnConfirm.addEventListener('pointercancel', ()=>{ showRadar(); });
    btnConfirm.addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); });

    // =============== 方向/地磁传感器（同时驱动指南针和雷达世界→设备旋转） ===============
    const needle=document.getElementById('needle');
    const headingTxt=document.getElementById('headingTxt');
    const requestPermBtn=document.getElementById('requestPerm');

    function updateHeading(deg){
      if (needle) needle.style.transform=`translateX(-50%) rotate(${deg}deg)`;
      if (headingTxt) headingTxt.textContent=`朝向：${deg.toFixed(0)}°`;
      state.headingRad = deg * Math.PI / 180; // 存成弧度给雷达用
    }

    async function requestPermissionIfNeeded(){
      const DOE = window.DeviceOrientationEvent;
      if (DOE && typeof DOE.requestPermission === 'function') {
        try { const res = await DOE.requestPermission(); return res === 'granted'; } catch(_) { return false; }
      }
      return true; // Android/桌面
    }

    function onDeviceOrientation(e){
      let heading; // 0=N，顺时针
      if (typeof e.webkitCompassHeading === 'number') heading = e.webkitCompassHeading;
      else if (typeof e.alpha === 'number') heading = 360 - e.alpha; // 近似
      if (typeof heading === 'number' && isFinite(heading)) { heading=(heading%360+360)%360; updateHeading(heading); }
    }

    // 授权按钮在雷达页
    requestPermBtn.addEventListener('click', async ()=>{
      const ok = await requestPermissionIfNeeded();
      if (ok) {
        if (window.DeviceOrientationEvent) {
          window.addEventListener('deviceorientation', onDeviceOrientation, { passive:true });
        }
        requestPermBtn.textContent = '已授权：转动设备查看变化';
      } else {
        requestPermBtn.textContent = '未授权/不支持：请在系统设置中开启';
      }
    });

    // =============== 初始化 ===============
    function init(){ fitCanvas(); randomBlips(3); if(state.animId) cancelAnimationFrame(state.animId); render(); }
    window.addEventListener('resize', fitCanvas);
    window.addEventListener('orientationchange', ()=> setTimeout(fitCanvas, 200));
    document.addEventListener('contextmenu', e=> e.preventDefault());
    init();
  </script>
</body>
</html>