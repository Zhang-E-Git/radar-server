<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>é€»è¾‘å’Œé¡µé¢å¸ƒå±€ - ç¼–è¾‘é¡µ</title>
<style>
body { font-family: Arial, sans-serif; background:#f5f5f5; padding:20px; }
.container { max-width:1000px; margin:0 auto; }
.rows-container { display:flex; flex-direction:column; gap:15px; margin-bottom:20px; }
.row-item { display:flex; align-items:center; gap:15px; padding:15px; background:white; border-radius:6px; }
.title-display, .url-display { flex:1; padding:10px; border-radius:6px; border:1px solid #ccc; }
.action-btn { padding:8px 15px; border:none; border-radius:6px; cursor:pointer; color:white; }
.jump-btn { background:#3498db; }
.edit-btn { background:#9b59b6; }
.add-btn { background:#2ecc71; }
.save-btn { background:#f39c12; }
.delete-btn { background:#e74c3c; }
</style>
</head>
<body>
<div class="container">
    <h1>é€»è¾‘å’Œé¡µé¢å¸ƒå±€ - ç¼–è¾‘é¡µ</h1>
    <div class="rows-container" id="rowsContainer"></div>
    <div style="display:flex; gap:15px; margin-top:10px;">
        <button class="action-btn add-btn" id="addNewRowBtn">+ å¢åŠ æ–°è¡Œ</button>
        <button class="action-btn save-btn" id="saveAllDataBtn">ğŸ’¾ ä¿å­˜</button>
        <a class="action-btn jump-btn" href="display.html" target="_blank">ğŸ”— æŸ¥çœ‹å±•ç¤ºé¡µ</a>
    </div>
    <div id="saveStatus" style="margin-top:10px;color:#27ae60"></div>
</div>

<!-- Supabase JS SDK -->
<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

// åˆå§‹åŒ– Supabase
const supabaseUrl = 'https://edvljqszrcdamkyhwkwo.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVkdmxqcXN6cmNkYW1reWh3a3dvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0Nzk3ODEsImV4cCI6MjA3MzA1NTc4MX0.GCg-_jHoWMLWPwAlLQiOynEDL2XW7DTU9CsMUPzpPB4';
const supabase = createClient(supabaseUrl, supabaseKey);

let rowIdCounter = 1;

const rowsContainer = document.getElementById('rowsContainer');
const addNewRowBtn = document.getElementById('addNewRowBtn');
const saveAllDataBtn = document.getElementById('saveAllDataBtn');
const saveStatus = document.getElementById('saveStatus');

function createRowElement(rowData) {
    const newRow = document.createElement('div');
    newRow.className = 'row-item';
    newRow.setAttribute('data-id', rowData.id);
    newRow.innerHTML = `
        <div class="title-display">${rowData.title}</div>
        <div class="url-display">${rowData.url}</div>
        <button class="action-btn jump-btn">â†— è·³è½¬</button>
        <button class="action-btn edit-btn">âœ ç¼–è¾‘</button>
        <button class="action-btn delete-btn">âœ• åˆ é™¤</button>
    `;

    // è·³è½¬æŒ‰é’®
    const jumpBtn = newRow.querySelector('.jump-btn');
    jumpBtn.addEventListener('click', () => {
        const url = newRow.querySelector('.url-display').textContent.trim();
        if(!url) { alert('é“¾æ¥ä¸ºç©º'); return; }
        window.open(url, '_blank');
    });

    // ç¼–è¾‘æŒ‰é’®
    const editBtn = newRow.querySelector('.edit-btn');
    editBtn.addEventListener('click', () => {
        if(editBtn.textContent === 'âœ ç¼–è¾‘') {
            enterEditMode(newRow, editBtn);
        } else if(editBtn.textContent === 'âœ“ å®Œæˆ') {
            finishEditMode(newRow, editBtn);
        }
    });

    // åˆ é™¤æŒ‰é’®
    const deleteBtn = newRow.querySelector('.delete-btn');
    deleteBtn.addEventListener('click', async () => {
        const id = newRow.getAttribute('data-id');
        if(id.toString().startsWith('temp-')) {
            // åªæ˜¯å‰ç«¯ä¸´æ—¶è¡Œï¼Œç›´æ¥ç§»é™¤
            newRow.remove();
            return;
        }
        if(!confirm('ç¡®è®¤åˆ é™¤è¯¥è¡Œå—ï¼Ÿ')) return;
        try {
            const { error } = await supabase.from('rows').delete().eq('id', id);
            if(error) throw error;
            newRow.remove();
            saveStatus.textContent = 'åˆ é™¤æˆåŠŸï¼';
        } catch(e) {
            alert('åˆ é™¤å¤±è´¥: ' + e.message);
        }
    });

    return newRow;
}

function renderRow(rowData) {
    const existingRow = rowsContainer.querySelector(`[data-id="${rowData.id}"]`);
    if(existingRow) {
        rowsContainer.replaceChild(createRowElement(rowData), existingRow);
    } else {
        rowsContainer.appendChild(createRowElement(rowData));
    }
}

// æ–°å¢è¡Œå‡½æ•°ï¼Œç›´æ¥æ’å…¥æ•°æ®åº“
async function addNewRow(title = '', url = '') {
    try {
        // ä¸ä¼  idï¼Œè®©æ•°æ®åº“è‡ªå¢ç”Ÿæˆ
        const { data, error } = await supabase
            .from('rows')
            .insert({ title, url })
            .select();
        if (error) throw error;
        if (data && data.length > 0) {
            renderRow(data[0]);
            saveStatus.textContent = 'æ–°å¢æˆåŠŸï¼';
        }
    } catch (e) {
        alert('æ–°å¢å¤±è´¥: ' + e.message);
    }
}

function enterEditMode(row, editBtn) {
    const titleElem = row.querySelector('.title-display');
    const urlElem = row.querySelector('.url-display');

    const titleEdit = document.createElement('div');
    titleEdit.className = 'title-display';
    titleEdit.contentEditable = true;
    titleEdit.textContent = titleElem.textContent;

    const urlEdit = document.createElement('div');
    urlEdit.className = 'url-display';
    urlEdit.contentEditable = true;
    urlEdit.textContent = urlElem.textContent;

    row.replaceChild(titleEdit, titleElem);
    row.replaceChild(urlEdit, urlElem);

    editBtn.textContent = 'âœ“ å®Œæˆ';

    // é˜²æ­¢å¤šæ¬¡ç»‘å®š
    titleEdit.removeEventListener('keydown', titleEdit._enterHandler);
    urlEdit.removeEventListener('keydown', urlEdit._enterHandler);

    titleEdit._enterHandler = (e) => { if(e.key === 'Enter') { e.preventDefault(); titleEdit.blur(); } };
    urlEdit._enterHandler = (e) => { if(e.key === 'Enter') { e.preventDefault(); urlEdit.blur(); } };

    titleEdit.addEventListener('keydown', titleEdit._enterHandler);
    urlEdit.addEventListener('keydown', urlEdit._enterHandler);
}

async function finishEditMode(row, editBtn) {
    const titleEdit = row.querySelector('.title-display');
    const urlEdit = row.querySelector('.url-display');

    const newTitle = titleEdit.textContent.trim();
    const newUrl = urlEdit.textContent.trim();
    const id = row.getAttribute('data-id');

    try {
        if(id.toString().startsWith('temp-')) {
            // ä¸´æ—¶è¡Œä¸åº”å­˜åœ¨ï¼Œç†è®ºä¸Šä¸ä¼šåˆ°è¿™é‡Œ
            alert('ä¸´æ—¶è¡Œæ— æ³•ç¼–è¾‘ä¿å­˜ï¼Œè¯·åˆ·æ–°é¡µé¢ã€‚');
            return;
        }
        const { error } = await supabase.from('rows').update({title: newTitle, url: newUrl}).eq('id', id);
        if(error) throw error;

        // æ›¿æ¢ä¸ºä¸å¯ç¼–è¾‘å…ƒç´ 
        const titleDisplay = document.createElement('div');
        titleDisplay.className = 'title-display';
        titleDisplay.textContent = newTitle;

        const urlDisplay = document.createElement('div');
        urlDisplay.className = 'url-display';
        urlDisplay.textContent = newUrl;

        row.replaceChild(titleDisplay, titleEdit);
        row.replaceChild(urlDisplay, urlEdit);

        editBtn.textContent = 'âœ ç¼–è¾‘';
        saveStatus.textContent = 'æ›´æ–°æˆåŠŸï¼';
    } catch(e) {
        alert('æ›´æ–°å¤±è´¥: ' + e.message);
    }
}

// ä¿å­˜æ‰€æœ‰è¡Œï¼Œé’ˆå¯¹æ–°å¢çš„ä¸´æ—¶è¡Œï¼ˆç†è®ºä¸Šä¸ä¼šæœ‰ä¸´æ—¶è¡Œï¼Œå› ä¸ºæ–°å¢å³æ’å…¥ï¼‰
async function saveAllData() {
    // è¿™é‡Œä¸å†æœ‰ä¸´æ—¶è¡Œï¼Œå› ä¸ºæ–°å¢è¡Œç›´æ¥æ’å…¥æ•°æ®åº“äº†
    saveStatus.textContent = 'æ‰€æœ‰æ•°æ®å·²å®æ—¶ä¿å­˜ï¼Œæ— éœ€æ‰‹åŠ¨ä¿å­˜ã€‚';
}

// ä» Supabase åŠ è½½æ•°æ®
async function loadRowsFromSupabase() {
    rowsContainer.innerHTML = '';
    try {
        const { data, error } = await supabase.from('rows').select('*').order('id', {ascending:true});
        if(error) throw error;
        data.forEach(row => renderRow(row));
    } catch(e) {
        alert('åŠ è½½æ•°æ®å¤±è´¥: ' + e.message);
    }
}

// åˆå§‹åŒ–ç»‘å®šäº‹ä»¶
function init() {
    addNewRowBtn.addEventListener('click', () => {
        addNewRow('æ–°æ ‡é¢˜', 'https://');
    });
    saveAllDataBtn.addEventListener('click', () => {
        saveAllData();
    });
    loadRowsFromSupabase();
}

window.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>